# ğŸ¬ LatentSync â€“ Super-Resolution Enhancement (GFPGAN + CodeFormer)

This project extends the **LatentSync lip-sync video generation** pipeline by adding **super-resolution enhancement** using **GFPGAN** and **CodeFormer**.  
The enhancement is applied only to the **mouth region** of each frame â€” the region generated by LatentSync â€” to restore facial details and improve video quality.

---

## ğŸ§  Project Summary

- Implemented **super-resolution integration** into the existing LatentSync workflow (`inference.py`).
- Added a new argument:
  ```bash
  --superres [GFPGAN | CodeFormer]

to choose between the two models.
The enhancement applies only on the generated subregion (mouth), keeping the rest of the frame untouched.
Used OpenCV for region extraction and re-merging and handled empty-frame errors gracefully.
Verified both models: GFPGAN (working fine) and CodeFormer (after fixing missing modules and version errors).

âš™ï¸ Environment Setup
1ï¸âƒ£ Installation Steps (Executed in Google Colab)
!pip install torch==2.2.1 torchvision==0.17.1 torchaudio==2.2.1
!pip install basicsr==1.4.2 facexlib==0.3.0 gfpgan==1.3.8 tqdm ffmpeg-python

2ï¸âƒ£ Verify Installed Versions
import torch, torchvision, gfpgan
print("Torch:", torch.__version__)
print("Torchvision:", torchvision.__version__)
print("GFPGAN imported successfully!")

âœ… Output:
Torch: 2.2.1+cu121
Torchvision: 0.17.1+cu121
GFPGAN imported successfully!

ğŸ§© Folder Structure (as per Drive)
LatentSync_Fresh/
â”œâ”€â”€ CodeFormer/
â”‚   â”œâ”€â”€ basicsr/
â”‚   â”‚   â”œâ”€â”€ __init__.py     âœ… Fixed imports to skip arcface_arch issue
â”‚   â”‚   â”œâ”€â”€ version.py      âœ… Added (__version__ = "1.0.0")
â”‚   â”‚   â””â”€â”€ archs/
â”‚   â”‚       â”œâ”€â”€ codeformer_arch.py
â”‚   â”‚       â”œâ”€â”€ arcface_arch.py âœ… Added missing file
â”‚   â”‚       â”œâ”€â”€ rrdbnet_arch.py
â”‚   â”‚       â””â”€â”€ vqgan_arch.py
â”œâ”€â”€ GFPGAN/
â”‚   â”œâ”€â”€ experiments/pretrained_models/GFPGANv1.4.pth
â”œâ”€â”€ inference.py              âœ… Final working script (GFPGAN + CodeFormer)
â”œâ”€â”€ inference_old.py
â”œâ”€â”€ LatentSync_SuperResolution.ipynb
â”œâ”€â”€ lipsynced.mp4
â”œâ”€â”€ input_video_with_audio.mp4
â”œâ”€â”€ output_GFPGAN_Final.mp4
â”œâ”€â”€ output_CodeFormer_final.mp4
â””â”€â”€ output_CodeFormer_fixed/
    â”œâ”€â”€ cropped_faces/
    â”œâ”€â”€ restored_faces/
    â””â”€â”€ final_results/

âš™ï¸ Final inference.py Highlights

âœ… Handles both GFPGAN & CodeFormer
âœ… Automatically downloads pretrained weights
âœ… Detects low-resolution region dynamically
âœ… Uses safe OpenCV boundary cropping
âœ… Includes fallback for skipped/empty frames

ğŸš€ Commands Used
ğŸ”¹ Run with GFPGAN
python inference.py --input input_video_with_audio.mp4 --output output_GFPGAN_Final.mp4 --superres GFPGAN


Output Log Snippet:

ğŸ¬ Processing 1788 frames using GFPGAN (Fast Mode)...
ğŸ”¹ Loading GFPGAN model (fast mode)...
100% 1788/1788 [00:14<00:00, 124.15it/s]
âœ… Fast enhanced video saved: /content/drive/MyDrive/LatentSync_Fresh/output_GFPGAN_Final.mp4

ğŸ”¹ Run with CodeFormer
python inference.py --input input_video_with_audio.mp4 --output output_CodeFormer_final.mp4 --superres CodeFormer


Fixes Applied Before Run:

Added missing file:
CodeFormer/basicsr/archs/arcface_arch.py

Created missing version file:
CodeFormer/basicsr/version.py

__version__ = "1.0.0"
__gitsha__ = "local-build"


Fixed dynamic import issue inside __init__.py by skipping arcface_arch loading.

ğŸ“ Output Samples
Type	Example
Input Video	lipsynced.mp4
GFPGAN Enhanced	output_GFPGAN_Final.mp4
CodeFormer Enhanced	output_CodeFormer_final.mp4

Google Drive (Models + Outputs):
ğŸ”— https://drive.google.com/drive/folders/1cPYHe6GNPAXR75eVMDJiEx8Hw1eIAP0T?usp=sharing

âš¡ Key Fixes Done
Problem	Fix Implemented
ModuleNotFoundError: torchvision.transforms.functional_tensor	Updated to torchvision.transforms.functional
Missing arcface_arch	Added dummy file manually
Missing basicsr.version	Created version.py
Long runtime (20â€“30 mins)	Optimized by applying on every 3rd frame (Fast Mode)
Frame resize assertion error	Added safe boundary cropping

ğŸ§© Process Workflow (Implemented)
Input Video  â†’  Extract Center ROI  â†’  Resolution Check
       â†“               â†“                    â†“
     GFPGAN / CodeFormer Applied (if low-res)
       â†“
Enhanced Region Replaced in Original Frame
       â†“
Output Video Saved (output_GFPGAN_Final.mp4 / output_CodeFormer_final.mp4)


ğŸ“š Tools & Frameworks Used
ğŸ§  PyTorch 2.2.1 (CUDA 12.1)
ğŸ§© GFPGAN 1.3.8
ğŸ” CodeFormer (Custom basicsr setup)

ğŸ§° OpenCV
âš™ï¸ FFmpeg + tqdm (for visualization)

ğŸ“š References
GFPGAN Official Repo
CodeFormer Official Repo
LatentSync (Base Project)

GitHub Repository:
ğŸ”— https://github.com/
<yourusername>/LatentSync

Added super-resolution enhancement with GFPGAN & CodeFormer + fixed basicsr import issues.
ğŸ’¡ All results are tested in Google Colab (Tesla T4 GPU, CUDA 12.1). Fast Mode completes ~1800 frames in 15â€“25 seconds.
